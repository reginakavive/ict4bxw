on: [push, pull_request]

name: deploy-shiny

jobs:
  deploy-shiny:
    runs-on: macOS-latest
    steps:
    
      - uses: actions/checkout@v2
      - uses: r-lib/actions/setup-r@v2
    
      
      - name: Install dependencies
        run: |
          install.packages("rsconnect", repos = "http://cran.us.r-project.org")
          install.packages("shiny", repos = "http://cran.us.r-project.org")
          
          install.packages("units", repos = "http://cran.us.r-project.org") 
          install.packages("remotes", repos="http://cran.us.r-project.org")
          install.packages("sp", repos="http://cran.us.r-project.org")
          
          
          install.packages(c('rdrop2','Cairo','tidyr', 'tidyverse', 'zoo','grDevices', 'ggplot2',  'latticeExtra',  'lubridate', 'magrittr', 'maptools', 
                   'naniar', 'plotly', 'png',   'rmarkdown', 'scales', 'shiny', 'shinyjs','rgeos', 'rgdal','shinyWidgets','raster','sf','tidyverse','gstat','leaflet','mapview'
                    ), repos = "http://cran.us.r-project.org")
          
          
        shell: Rscript {0}
      - name: Push to shinyapps.io
        run: |
          rsconnect::setAccountInfo(name="${{secrets.SHINY_ACC_NAME}}", token="${{secrets.TOKEN}}", secret="${{secrets.SECRET}}")
          rsconnect::deployApp(appName = 'bxwsurveillancett')
          
          install.packages('cronR', repos = "http://cran.us.r-project.org")
          r <- cronR::cron_rscript("Incidence sms alert/Alert_sectors_clean.R")
          cronR::cron_add(r, frequency = "daily", id="job_1", at = "00:00", description = "update_data", ask = FALSE)
          
          
        shell: Rscript {0}
     
     